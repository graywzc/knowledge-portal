<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Portal</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f5f5f5; }

    /* Sidebar: tree view */
    #sidebar { width: 260px; background: #1a1a2e; color: #eee; padding: 16px; overflow-y: auto; }
    #sidebar h2 { font-size: 14px; text-transform: uppercase; color: #888; margin-bottom: 12px; }
    .tree-node { padding: 6px 8px; cursor: pointer; border-radius: 4px; font-size: 14px; }
    .tree-node:hover { background: rgba(255,255,255,0.1); }
    .tree-node.active { background: rgba(100,140,255,0.3); }
    .tree-children { margin-left: 16px; border-left: 1px solid #333; }

    /* Main: messages */
    #main { flex: 1; display: flex; flex-direction: column; }
    #layer-header { padding: 12px 20px; background: #fff; border-bottom: 1px solid #ddd; font-weight: 600; }
    #messages { flex: 1; overflow-y: auto; padding: 20px; }
    .msg { max-width: 600px; margin-bottom: 12px; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .msg.self { background: #d1e7ff; margin-left: auto; }
    .msg.other { background: #fff; border: 1px solid #ddd; }
    .msg .meta { font-size: 11px; color: #888; margin-top: 4px; }

    /* Input */
    #input-area { padding: 12px 20px; background: #fff; border-top: 1px solid #ddd; display: flex; gap: 8px; }
    #input-area input { flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    #input-area select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 13px; }
    #input-area button { padding: 8px 16px; background: #4a6cf7; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Layers</h2>
    <div id="tree"></div>
  </div>
  <div id="main">
    <div id="layer-header">Layer A</div>
    <div id="messages"></div>
    <div id="input-area">
      <select id="sender-select">
        <option value="self">Self</option>
        <option value="other">Other</option>
      </select>
      <input id="msg-input" placeholder="Type a message..." />
      <select id="reply-select"><option value="">No reply</option></select>
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
    let currentLayer = 'A';
    let msgCounter = 0;

    async function api(method, path, body) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch('/api' + path, opts);
      return res.json();
    }

    async function refresh() {
      const tree = await api('GET', '/tree');
      const current = await api('GET', '/current');
      currentLayer = current.currentLayerId;
      renderTree(tree);
      await showLayer(currentLayer);
    }

    function renderTree(node, container) {
      if (!container) {
        container = document.getElementById('tree');
        container.innerHTML = '';
      }
      const div = document.createElement('div');
      div.className = 'tree-node' + (node.id === currentLayer ? ' active' : '');
      div.textContent = `Layer ${node.id} (${node.messageCount})`;
      div.onclick = (e) => { e.stopPropagation(); showLayer(node.id); };
      container.appendChild(div);

      if (node.children.length) {
        const childContainer = document.createElement('div');
        childContainer.className = 'tree-children';
        node.children.forEach(c => renderTree(c, childContainer));
        container.appendChild(childContainer);
      }
    }

    async function showLayer(id) {
      const layer = await api('GET', `/layers/${id}`);
      currentLayer = id;
      document.getElementById('layer-header').textContent = `Layer ${id}` +
        (layer.parentLayerId ? ` (child of ${layer.parentLayerId})` : ' (root)');

      const msgDiv = document.getElementById('messages');
      msgDiv.innerHTML = '';
      const replySelect = document.getElementById('reply-select');
      replySelect.innerHTML = '<option value="">No reply</option>';

      layer.messages.forEach((m, i) => {
        const el = document.createElement('div');
        el.className = `msg ${m.sender}`;
        el.innerHTML = `${m.content}<div class="meta">${m.id} · ${m.sender}${m.replyToId ? ' · reply to ' + m.replyToId : ''}</div>`;
        msgDiv.appendChild(el);

        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `↩ ${m.id} (${m.sender})`;
        replySelect.appendChild(opt);
      });

      // Also refresh tree highlighting
      const tree = await api('GET', '/tree');
      renderTree(tree);
    }

    document.getElementById('send-btn').onclick = async () => {
      const input = document.getElementById('msg-input');
      const content = input.value.trim();
      if (!content) return;

      const sender = document.getElementById('sender-select').value;
      const replyToId = document.getElementById('reply-select').value || null;

      await api('POST', '/messages', {
        id: `msg-${++msgCounter}`,
        sender,
        replyToId,
        content,
        timestamp: Date.now(),
      });

      input.value = '';
      document.getElementById('reply-select').value = '';
      await refresh();
    };

    document.getElementById('msg-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('send-btn').click();
    });

    refresh();
  </script>
</body>
</html>
